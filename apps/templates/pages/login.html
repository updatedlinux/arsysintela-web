{% extends 'layouts/base.html' %}

{% block title %}Portal de Clientes - Iniciar Sesión{% endblock title %}

{% block preloader %}
{% include 'partials/preloader.html' %}
{% endblock preloader %}

{% block icon %}
<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="{{ config.ASSETS_ROOT }}/favicon_io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="{{ config.ASSETS_ROOT }}/favicon_io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="{{ config.ASSETS_ROOT }}/favicon_io/favicon-16x16.png">
<link rel="manifest" href="{{ config.ASSETS_ROOT }}/favicon_io/site.webmanifest">
<link rel="shortcut icon" href="{{ config.ASSETS_ROOT }}/favicon_io/favicon.ico" type="image/x-icon">
{% endblock icon %}

{% block body_attribute %}class="body2 body"{% endblock body_attribute %}

{% block content %}

<!--=====log in area start=======-->
<div class="log-in-area sp _relative">
  <div class="container">
    <div class="row">
      <div class="col-lg-6 m-auto text-center">
        <div class="main-logo">
          <a href="/"><img
            src="{{ config.ASSETS_ROOT }}/img/logo/svgMAIN-intelalogo.svg" alt="Arsys Intela" style="width: 280px; height: auto;"></a>
        </div>
      </div>
    </div>
    <div class="space50"></div>
    <div class="row align-items-center">
      <div class="col-lg-6">
        <div class="login-form" style="margin-top: -20px;">
          <div class="headding">
            <h2>Portal de Clientes</h2>
            <p>Ingresa tus credenciales para acceder al portal.</p>
          </div>

          {% if error %}
          <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            <strong>Error:</strong> {{ error }}
          </div>
          {% endif %}

          <form method="POST" action="/login" class="inputs" id="loginForm">
            <div class="single-inputs">
              <label>Correo Electrónico</label>
              <input type="email" name="email" placeholder="Ingresa tu correo electrónico" required>
            </div>
            <div class="single-inputs">
              <label>Contraseña</label>
              <input type="password" name="password" placeholder="Ingresa tu contraseña" required>
            </div>
            <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">
            <div class="button">
              <button type="submit" class="theme-btn2" id="loginSubmitBtn">Iniciar Sesión</button>
            </div>
          </form>

          <div class="forgot-text">
            <p><a href="/">Volver al inicio</a></p>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="login-img">
          <img src="{{ config.ASSETS_ROOT }}/img/others/login-page-img.png" alt="">
        </div>
      </div>
    </div>
  </div>
  <img class="shape1" src="{{ config.ASSETS_ROOT }}/img/shapes/apps-shape1.png" alt="">
  <img class="shape2" src="{{ config.ASSETS_ROOT }}/img/shapes/apps-shape1.png" alt="">
</div>
<!--=====log in area end=======-->

{% endblock content %}

{% block extra_javascript %}
{% if config and config.RECAPTCHA_SITE_KEY %}
<!-- Google reCAPTCHA v3 -->
<script src="https://www.google.com/recaptcha/api.js?render={{ config.RECAPTCHA_SITE_KEY }}&badge=bottomright"></script>
<script>
(function() {
  'use strict';
  
  const siteKey = '{{ config.RECAPTCHA_SITE_KEY }}';
  
  console.log('[reCAPTCHA] Inicializando...', {siteKey: siteKey ? '✓ Configurada' : '✗ No configurada'});
  
  if (!siteKey || siteKey === 'None' || siteKey === '') {
    console.warn('[reCAPTCHA] SITE_KEY no configurada o vacía');
    return;
  }
  
  // Esperar a que el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRecaptcha);
  } else {
    initRecaptcha();
  }
  
  function initRecaptcha() {
    const loginForm = document.getElementById('loginForm');
    const submitBtn = document.getElementById('loginSubmitBtn');
    
    if (!loginForm || !submitBtn) {
      console.error('[reCAPTCHA] No se encontraron los elementos del formulario');
      return;
    }
    
    // Verificar que grecaptcha se cargó (puede tardar un momento)
    function checkGrecaptcha() {
      if (typeof grecaptcha !== 'undefined') {
        console.log('[reCAPTCHA] Script cargado correctamente');
        console.log('[reCAPTCHA] Badge debería estar visible en la esquina inferior derecha');
        setupFormHandler();
      } else {
        console.warn('[reCAPTCHA] Esperando a que el script se cargue...');
        setTimeout(checkGrecaptcha, 100);
      }
    }
    
    function setupFormHandler() {
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        console.log('[reCAPTCHA] Formulario enviado, obteniendo token...');
        
        // Deshabilitar botón para evitar múltiples envíos
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Verificando...';
        
        // Ejecutar reCAPTCHA v3
        grecaptcha.ready(function() {
          grecaptcha.execute(siteKey, {action: 'login'}).then(function(token) {
            console.log('[reCAPTCHA] ✓ Token obtenido exitosamente (longitud:', token.length, 'caracteres)');
            
            // Agregar token al formulario
            document.getElementById('g-recaptcha-response').value = token;
            
            // Enviar formulario
            loginForm.submit();
          }).catch(function(error) {
            console.error('[reCAPTCHA] ✗ Error obteniendo token:', error);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            alert('Error en la verificación de seguridad. Intenta nuevamente.');
          });
        });
      });
      
      console.log('[reCAPTCHA] ✓ Listo para usar');
    }
    
    checkGrecaptcha();
  }
})();
</script>
{% else %}
<script>
console.warn('[reCAPTCHA] No configurado - Verifica que RECAPTCHA_SITE_KEY esté en el .env');
</script>
{% endif %}
{% endblock extra_javascript %}

