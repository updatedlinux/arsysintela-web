{% extends 'layouts/landing-layout.html' %}

{% block title %}Portal de Clientes - Arsys Intela{% endblock title %}

{# Excluir CTA para esta página #}
{% block cta_override %}{% endblock %}

{% block icon %}
<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="{{ config.ASSETS_ROOT }}/favicon_io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="{{ config.ASSETS_ROOT }}/favicon_io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="{{ config.ASSETS_ROOT }}/favicon_io/favicon-16x16.png">
<link rel="manifest" href="{{ config.ASSETS_ROOT }}/favicon_io/site.webmanifest">
<link rel="shortcut icon" href="{{ config.ASSETS_ROOT }}/favicon_io/favicon.ico" type="image/x-icon">
{% endblock icon %}

{% block body_attribute %}class="body2 body portal-clientes-page"{% endblock body_attribute %}

{% block extra_css %}
<style>
/* Estilos específicos para Portal de Clientes - Reducir separación al mínimo */
.portal-clientes-hero.pages-hero {
  position: relative;
  min-height: 100px;
  display: flex;
  align-items: center;
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}

.portal-clientes-hero .container {
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}

.portal-clientes-hero + .portal-clientes-content,
.pages-hero.portal-clientes-hero + .about-boxs.portal-clientes-content {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

.portal-clientes-content.about-boxs {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

.portal-clientes-content.about-boxs .container {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

.portal-clientes-content.about-boxs .single-box {
  margin-top: 0 !important;
}

/* Asegurar que no haya espacios adicionales */
body.portal-clientes-page .pages-hero.portal-clientes-hero {
  position: relative;
  min-height: 100px;
  display: flex;
  align-items: center;
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}

body.portal-clientes-page .about-boxs.portal-clientes-content {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Reducir cualquier padding adicional del hero */
body.portal-clientes-page .pages-hero.portal-clientes-hero .container {
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}

/* Ocultar shapes del hero que pueden crear espacio */
.portal-clientes-hero .hero-shape1,
.portal-clientes-hero .hero-shape2 {
  display: none !important;
}
</style>
{% endblock extra_css %}

{% block page_content %}

<!--===== HERO AREA START =======-->
<div class="pages-hero portal-clientes-hero">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-12">
        <div class="main-headding">
          <h1>Portal de Clientes</h1>
        </div>
      </div>
    </div>
  </div>
  <img class="hero-shape1" src="{{ config.ASSETS_ROOT }}/img/shapes/common-hero-shape1.png" alt="">
  <img class="hero-shape2" src="{{ config.ASSETS_ROOT }}/img/shapes/common-hero-shape2.png" alt="">
</div>
<!--===== HERO AREA END =======-->

{% if is_user %}
{# Vista para usuarios con rol 'user': mostrar información del cliente y productos asociados #}

<!--===== CLIENT INFO AREA START =======-->
<div class="about-boxs">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        {% if client %}
        <div class="single-box" style="flex-direction: column; align-items: flex-start;">
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 25px;">
            <div class="headding2" style="margin-bottom: 0;">
              <h2>Mi Información</h2>
            </div>
            <div>
              <a href="/logout" class="theme-btn3">Cerrar Sesión</a>
            </div>
          </div>

          <div class="row" style="width: 100%;">
            <div class="col-md-3 text-center">
              <div style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <i class="fa-regular fa-user" style="font-size: 60px; color: #fff;"></i>
              </div>
            </div>
            <div class="col-md-9">
              <div class="row">
                <div class="col-md-6">
                  <p style="margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fa-regular fa-user" style="width: 20px; margin-right: 10px; color: var(--qt-text-h-text2, #1a1a1a);"></i>
                    <span><strong>Nombre:</strong> {{ client.get('name', 'N/A') }}</span>
                  </p>
                  <p style="margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fa-regular fa-envelope" style="width: 20px; margin-right: 10px; color: var(--qt-text-h-text2, #1a1a1a);"></i>
                    <span><strong>Email:</strong> {{ client.get('email', 'N/A') }}</span>
                  </p>
                  <p style="margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fa-regular fa-phone" style="width: 20px; margin-right: 10px; color: var(--qt-text-h-text2, #1a1a1a);"></i>
                    <span><strong>Teléfono:</strong> {{ client.get('phone', 'No especificado') }}</span>
                  </p>
                </div>
                <div class="col-md-6">
                  <p style="margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fa-regular fa-building" style="width: 20px; margin-right: 10px; color: var(--qt-text-h-text2, #1a1a1a);"></i>
                    <span><strong>Empresa:</strong> {{ client.get('company', 'No especificado') }}</span>
                  </p>
                  {% if client.get('notes') %}
                  <p style="margin-bottom: 15px; display: flex; align-items: flex-start;">
                    <i class="fa-regular fa-note-sticky" style="width: 20px; margin-right: 10px; color: var(--qt-text-h-text2, #1a1a1a); margin-top: 3px;"></i>
                    <span><strong>Notas:</strong> {{ client.notes }}</span>
                  </p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin-top: 30px; border: 1px solid #f5c6cb;">
          <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<!--===== CLIENT INFO AREA END =======-->

<!--===== PRODUCTS AREA START =======-->
<div class="about-page-area1 sp">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="headding2">
          <h2>Mis Productos</h2>
        </div>

        {% if products and products|length > 0 %}
        <div class="table-responsive" style="overflow-x: auto; margin-top: 30px;">
          <table class="table" style="width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px;">
            <thead style="background-color: var(--qt-text-h-text2, #1a1a1a); color: #fff;">
              <tr>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Código</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Nombre</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Descripción</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Estado</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Fecha Inicio</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Fecha Fin</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Notas</th>
              </tr>
            </thead>
            <tbody>
              {% for product_rel in products %}
              {% set product = product_rel.get('product', {}) %}
              {% set client_product = product_rel.get('ClientProduct', {}) %}
              {% set status = client_product.get('status', '') %}
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 15px;">{{ product.get('code', 'N/A') }}</td>
                <td style="padding: 15px;">{{ product.get('name', 'N/A') }}</td>
                <td style="padding: 15px;">
                  {% if product.get('description') %}
                    {% if product.description|length > 50 %}
                      {{ product.description[:50] }}...
                    {% else %}
                      {{ product.description }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td style="padding: 15px;">
                  {% if status == 'activo' %}
                    <span style="padding: 5px 10px; border-radius: 4px; font-size: 12px; background-color: #d4edda; color: #155724;">
                      {{ status|title }}
                    </span>
                  {% elif status == 'suspendido' %}
                    <span style="padding: 5px 10px; border-radius: 4px; font-size: 12px; background-color: #fff3cd; color: #856404;">
                      {{ status|title }}
                    </span>
                  {% elif status == 'finalizado' %}
                    <span style="padding: 5px 10px; border-radius: 4px; font-size: 12px; background-color: #f8d7da; color: #721c24;">
                      {{ status|title }}
                    </span>
                  {% else %}
                    <span style="padding: 5px 10px; border-radius: 4px; font-size: 12px; background-color: #e2e3e5; color: #383d41;">
                      {{ status|title if status else 'N/A' }}
                    </span>
                  {% endif %}
                </td>
                <td style="padding: 15px;">
                  {% if client_product.get('startDate') %}
                    {{ client_product.startDate }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td style="padding: 15px;">
                  {% if client_product.get('endDate') %}
                    {{ client_product.endDate }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td style="padding: 15px;">
                  {% if client_product.get('notes') %}
                    {% if client_product.notes|length > 50 %}
                      {{ client_product.notes[:50] }}...
                    {% else %}
                      {{ client_product.notes }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% else %}
        <div class="alert alert-info" style="background-color: #d1ecf1; color: #0c5460; padding: 20px; border-radius: 4px; text-align: center; border: 1px solid #bee5eb; margin-top: 30px;">
          <p style="margin: 0; font-size: 16px;">No tienes productos asociados actualmente.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<!--===== PRODUCTS AREA END =======-->

{% else %}
{# Vista para administradores: mostrar listado de clientes #}

<!--===== CLIENTS LIST AREA START =======-->
<div class="about-boxs portal-clientes-content">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap;">
          <div class="headding2" style="margin-bottom: 0;">
            <h2>Listado de Clientes</h2>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="button" class="theme-btn2" id="openCreateClientModal">
              <i class="fa-regular fa-plus"></i> Crear Cliente
            </button>
            <a href="/logout" class="theme-btn3">Cerrar Sesión</a>
          </div>
        </div>

        {% if error %}
        <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin-bottom: 30px; border: 1px solid #f5c6cb;">
          <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        {% if clients and clients|length > 0 %}
        <div class="table-responsive" style="overflow-x: auto;">
          <table class="table" style="width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px;">
            <thead style="background-color: var(--qt-text-h-text2, #1a1a1a); color: #fff;">
              <tr>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Nombre</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Teléfono</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Empresa</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Notas</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Fecha Alta</th>
              </tr>
            </thead>
            <tbody>
              {% for client in clients %}
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 15px;">{{ client.get('name', 'N/A') }}</td>
                <td style="padding: 15px;">{{ client.get('email', 'N/A') }}</td>
                <td style="padding: 15px;">{{ client.get('phone', 'N/A') }}</td>
                <td style="padding: 15px;">{{ client.get('company', 'N/A') }}</td>
                <td style="padding: 15px;">
                  {% if client.get('notes') %}
                    {% if client.notes|length > 50 %}
                      {{ client.notes[:50] }}...
                    {% else %}
                      {{ client.notes }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td style="padding: 15px;">
                  {% if client.get('createdAt') %}
                    {{ client.createdAt[:10] }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        {% if pagination and pagination.get('totalPages', 0) > 1 %}
        <div class="pagination-area" style="margin-top: 40px; display: flex; justify-content: center; align-items: center; gap: 10px;">
          <div style="margin-right: 20px;">
            <span>Página {{ pagination.get('page', 1) }} de {{ pagination.get('totalPages', 1) }}</span>
            <span style="margin-left: 10px; color: #666;">(Total: {{ pagination.get('total', 0) }} clientes)</span>
          </div>
          
          {% if pagination.get('page', 1) > 1 %}
          <a href="/portal-clientes?page={{ pagination.page - 1 }}&limit={{ pagination.get('limit', 10) }}" class="theme-btn3">Anterior</a>
          {% endif %}
          
          {% if pagination.get('page', 1) < pagination.get('totalPages', 1) %}
          <a href="/portal-clientes?page={{ pagination.page + 1 }}&limit={{ pagination.get('limit', 10) }}" class="theme-btn2">Siguiente</a>
          {% endif %}
        </div>
        {% endif %}

        {% else %}
        <div style="text-align: center;">
          <div class="alert alert-info" style="background-color: #d1ecf1; color: #0c5460; padding: 20px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #bee5eb;">
            <p style="margin: 0; font-size: 16px;">No hay clientes registrados todavía.</p>
          </div>
          <button type="button" class="theme-btn2" id="openCreateClientModalEmpty">
            <i class="fa-regular fa-plus"></i> Crear Primer Cliente
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<!--===== CLIENTS LIST AREA END =======-->

{% endif %}

{% include 'partials/back-to-top.html' %}

{# Modal para crear cliente (solo para administradores) #}
{% if not is_user %}
<!-- Modal Crear Cliente -->
<div class="modal fade" id="createClientModal" tabindex="-1" aria-labelledby="createClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom: none;">
        <h5 class="modal-title" id="createClientModalLabel">
          <i class="fa-regular fa-user-plus"></i> Crear Nuevo Cliente
        </h5>
        <button type="button" class="close" onclick="closeModal()" aria-label="Close" style="color: white; opacity: 1; font-size: 28px; font-weight: bold; background: none; border: none; cursor: pointer;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="padding: 30px;">
        
        <!-- Paso 1: Crear Usuario -->
        <div id="step1-create-user">
          <h4 style="margin-bottom: 20px; color: var(--qt-text-h-text2, #1a1a1a);">
            <i class="fa-regular fa-user"></i> Paso 1: Crear Usuario
          </h4>
          <form id="createUserForm">
            <div class="mb-3">
              <label for="user_email" class="form-label"><i class="fa-regular fa-envelope"></i> Email <span style="color: red;">*</span></label>
              <input type="email" class="form-control" id="user_email" name="email" required placeholder="usuario@example.com">
            </div>
            <div class="mb-3">
              <label for="user_password" class="form-label"><i class="fa-regular fa-lock"></i> Contraseña <span style="color: red;">*</span></label>
              <input type="password" class="form-control" id="user_password" name="password" required placeholder="Mínimo 8 caracteres" minlength="8">
            </div>
            <div class="mb-3">
              <label for="user_name" class="form-label"><i class="fa-regular fa-user"></i> Nombre</label>
              <input type="text" class="form-control" id="user_name" name="name" placeholder="Nombre del usuario">
            </div>
            <div class="mb-3">
              <label for="user_role" class="form-label"><i class="fa-regular fa-shield"></i> Rol</label>
              <select class="form-control" id="user_role" name="role">
                <option value="user" selected>Usuario</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <div id="userFormError" class="alert alert-danger" style="display: none; margin-top: 15px;"></div>
            <div class="text-end">
              <button type="button" class="theme-btn3" onclick="closeModal()">Cancelar</button>
              <button type="submit" class="theme-btn2" style="margin-left: 10px;">
                <i class="fa-regular fa-arrow-right"></i> Continuar
              </button>
            </div>
          </form>
        </div>

        <!-- Paso 2: Completar Datos del Cliente -->
        <div id="step2-complete-client" style="display: none;">
          <h4 style="margin-bottom: 20px; color: var(--qt-text-h-text2, #1a1a1a);">
            <i class="fa-regular fa-building"></i> Paso 2: Completar Datos del Cliente
          </h4>
          <div class="alert alert-success" style="margin-bottom: 20px;">
            <i class="fa-regular fa-check-circle"></i> Usuario creado exitosamente. Ahora completa los datos del cliente.
          </div>
          <form id="updateClientForm">
            <input type="hidden" id="client_id" name="client_id">
            <div class="mb-3">
              <label for="client_name" class="form-label"><i class="fa-regular fa-user"></i> Nombre del Cliente <span style="color: red;">*</span></label>
              <input type="text" class="form-control" id="client_name" name="name" required placeholder="Nombre completo del cliente">
            </div>
            <div class="mb-3">
              <label for="client_email" class="form-label"><i class="fa-regular fa-envelope"></i> Email</label>
              <input type="email" class="form-control" id="client_email" name="email" placeholder="email@example.com">
            </div>
            <div class="mb-3">
              <label for="client_phone" class="form-label"><i class="fa-regular fa-phone"></i> Teléfono</label>
              <input type="text" class="form-control" id="client_phone" name="phone" placeholder="+34 600 123 456">
            </div>
            <div class="mb-3">
              <label for="client_company" class="form-label"><i class="fa-regular fa-building"></i> Empresa</label>
              <input type="text" class="form-control" id="client_company" name="company" placeholder="Nombre de la empresa">
            </div>
            <div class="mb-3">
              <label for="client_notes" class="form-label"><i class="fa-regular fa-note-sticky"></i> Notas</label>
              <textarea class="form-control" id="client_notes" name="notes" rows="3" placeholder="Notas adicionales sobre el cliente"></textarea>
            </div>
            <div id="clientFormError" class="alert alert-danger" style="display: none; margin-top: 15px;"></div>
            <div class="text-end">
              <button type="button" class="theme-btn3" onclick="closeModal()">Cancelar</button>
              <button type="submit" class="theme-btn2" style="margin-left: 10px;">
                <i class="fa-regular fa-check"></i> Crear Cliente
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
.modal-content {
  border-radius: 12px;
  overflow: hidden;
}

.modal-header {
  padding: 20px 30px;
}

.modal-body {
  padding: 30px;
}

.form-label {
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--qt-text-h-text2, #1a1a1a);
}

.form-control {
  border-radius: 6px;
  border: 1px solid #ddd;
  padding: 10px 15px;
}

.form-control:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}
</style>

<script>
// Prevenir error de progressPath en main.js
(function() {
  'use strict';
  // Interceptar querySelector para evitar error cuando main.js busca .progress-wrap path
  var originalQuerySelector = document.querySelector;
  document.querySelector = function(selector) {
    if (selector === '.progress-wrap path') {
      var element = originalQuerySelector.call(document, selector);
      if (!element) {
        // Si no existe, retornar un objeto mock para evitar el error
        return {
          getTotalLength: function() { return 0; },
          style: {
            transition: '',
            WebkitTransition: '',
            strokeDasharray: '',
            strokeDashoffset: ''
          },
          getBoundingClientRect: function() { return {}; }
        };
      }
      return element;
    }
    return originalQuerySelector.call(document, selector);
  };
})();
</script>

<script>
(function() {
  'use strict';
  
  let createdUserId = null;
  let createdClientId = null;

  // Resetear modal al cerrar
  function resetModal() {
    const step1 = document.getElementById('step1-create-user');
    const step2 = document.getElementById('step2-complete-client');
    if (step1) step1.style.display = 'block';
    if (step2) step2.style.display = 'none';
    const form1 = document.getElementById('createUserForm');
    const form2 = document.getElementById('updateClientForm');
    if (form1) form1.reset();
    if (form2) form2.reset();
    const error1 = document.getElementById('userFormError');
    const error2 = document.getElementById('clientFormError');
    if (error1) error1.style.display = 'none';
    if (error2) error2.style.display = 'none';
    createdUserId = null;
    createdClientId = null;
  }

  // Cerrar modal
  function closeModal() {
    const modal = document.getElementById('createClientModal');
    if (modal) {
      if (typeof jQuery !== 'undefined' && jQuery(modal).modal) {
        jQuery(modal).modal('hide');
      } else {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
      }
      resetModal();
    }
  }

  // Inicializar modal y eventos
  function initModal() {
    const modal = document.getElementById('createClientModal');
    if (!modal) return;

    // Abrir modal
    function openModal() {
      if (typeof jQuery !== 'undefined' && jQuery(modal).modal) {
        jQuery(modal).modal('show');
      } else {
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
      }
    }

    // Botones para abrir modal
    const openBtn1 = document.getElementById('openCreateClientModal');
    const openBtn2 = document.getElementById('openCreateClientModalEmpty');
    if (openBtn1) {
      openBtn1.addEventListener('click', openModal);
    }
    if (openBtn2) {
      openBtn2.addEventListener('click', openModal);
    }

    // Cerrar modal al hacer clic fuera
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Resetear modal al cerrar
    if (typeof jQuery !== 'undefined') {
      jQuery(modal).on('hidden.bs.modal', function () {
        resetModal();
      });
    }
    modal.addEventListener('hidden.bs.modal', function () {
      resetModal();
    });
    modal.addEventListener('hidden', function () {
      resetModal();
    });
  }

  // Formulario Paso 1: Crear Usuario
  function initCreateUserForm() {
    const form = document.getElementById('createUserForm');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        email: document.getElementById('user_email').value,
        password: document.getElementById('user_password').value,
        name: document.getElementById('user_name').value || null,
        role: document.getElementById('user_role').value
      };

      const errorDiv = document.getElementById('userFormError');
      if (errorDiv) errorDiv.style.display = 'none';

      try {
        const response = await fetch('/portal-clientes/create-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
          createdUserId = data.user.id;
          createdClientId = data.user.clientId;
          
          // Prellenar datos del cliente
          const clientIdInput = document.getElementById('client_id');
          const clientNameInput = document.getElementById('client_name');
          const clientEmailInput = document.getElementById('client_email');
          if (clientIdInput) clientIdInput.value = createdClientId;
          if (clientNameInput) clientNameInput.value = formData.name || '';
          if (clientEmailInput) clientEmailInput.value = formData.email;
          
          // Mostrar paso 2
          const step1 = document.getElementById('step1-create-user');
          const step2 = document.getElementById('step2-complete-client');
          if (step1) step1.style.display = 'none';
          if (step2) step2.style.display = 'block';
        } else {
          if (errorDiv) {
            errorDiv.textContent = data.error || 'Error al crear el usuario';
            errorDiv.style.display = 'block';
          }
        }
      } catch (error) {
        if (errorDiv) {
          errorDiv.textContent = 'Error de conexión. Intenta nuevamente.';
          errorDiv.style.display = 'block';
        }
        console.error('Error:', error);
      }
    });
  }

  // Formulario Paso 2: Actualizar Cliente
  function initUpdateClientForm() {
    const form = document.getElementById('updateClientForm');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clientIdInput = document.getElementById('client_id');
      if (!clientIdInput) return;
      
      const clientId = clientIdInput.value;
      const formData = {
        name: document.getElementById('client_name').value,
        email: document.getElementById('client_email').value || null,
        phone: document.getElementById('client_phone').value || null,
        company: document.getElementById('client_company').value || null,
        notes: document.getElementById('client_notes').value || null
      };

      const errorDiv = document.getElementById('clientFormError');
      if (errorDiv) errorDiv.style.display = 'none';

      try {
        const response = await fetch('/portal-clientes/update-client/' + clientId, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
          alert('Cliente creado exitosamente');
          closeModal();
          setTimeout(function() {
            window.location.reload();
          }, 300);
        } else {
          if (errorDiv) {
            errorDiv.textContent = data.error || 'Error al actualizar el cliente';
            errorDiv.style.display = 'block';
          }
        }
      } catch (error) {
        if (errorDiv) {
          errorDiv.textContent = 'Error de conexión. Intenta nuevamente.';
          errorDiv.style.display = 'block';
        }
        console.error('Error:', error);
      }
    });
  }

  // Inicializar todo cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initModal();
      initCreateUserForm();
      initUpdateClientForm();
    });
  } else {
    initModal();
    initCreateUserForm();
    initUpdateClientForm();
  }

  // Exponer closeModal globalmente
  window.closeModal = closeModal;
})();
</script>
{% endif %}

{% endblock page_content %}
